[env]
MISE_ENV = "hk"

[settings]
experimental = true # required for go for now

[tasks.ci]
description = "CI Steps (mise run test)"
run = ["mise run test"]

[tasks.format]
description = "Format code"
run = ["golangci-lint run --fix ./...", "golines . --write-output"]

[tasks.hooks]
description = "Run git hooks"
run = ["hk fix --quiet"]

[tasks.test]
description = "Run test"
# https://stackoverflow.com/a/21725603/3219667
run = "go test -timeout=30s -coverprofile=coverage.out -coverpkg=./... ./..."

[tasks."test:view-coverage"]
description = "View last run test coverage. Alternatively, use `gocovsh`"
# https://go.dev/blog/cover#heat-maps
run = "go tool cover -html=coverage.out"

[tasks."test:coverage-min"]
description = "Verify minimum coverage threshold (70%)"
run = '''
go test -coverprofile=coverage.out -coverpkg=./... ./...
coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
echo "Current coverage: ${coverage}%"
if (( $(awk "BEGIN {print ($coverage < 70)}") )); then
    echo "❌ Coverage ${coverage}% is below 70% minimum threshold"
    exit 1
fi
echo "✓ Coverage ${coverage}% meets 70% minimum threshold"
'''

[tasks."test:integration"]
description = "Run integration tests (pre-warms transformer model, longer timeout)"
run = "go test -tags=integration -timeout=10m -v ./internal/summarizer/..."

[tasks."test:integration-bench"]
description = "Run integration benchmarks (heuristic vs transformers)"
run = "go test -tags=integration -timeout=10m -bench=. -benchmem -run=^$ -v ./internal/summarizer/..."

[tasks.build]
description = "Build the project"
run = "go build -o gh-star-search"

[tasks.update]
description = "Update dependencies"
run = ["go get -u ./...", "go mod tidy"]
